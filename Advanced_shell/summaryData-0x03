#!/bin/bash

# Define the input directory and output file
INPUT_DIR="pokemon_data"
OUTPUT_FILE="pokemon_report.csv"

# Print the report generation message
echo "CSV Report generated at: $OUTPUT_FILE"

# --- Part 1: Generate the CSV File ---

# Print the CSV header directly to the output file
echo "Name,Height (m),Weight (kg)" > "$OUTPUT_FILE"

# Loop through all JSON files in the input directory
for file in "$INPUT_DIR"/*.json; do
    # Use jq to get the raw name, height, and weight as a comma-separated string.
    DATA_LINE=$(jq -r '[.name, .height, .weight] | join(",")' "$file")

    # Now, use awk to format the output and append to the CSV file.
    echo "$DATA_LINE" | awk '
        BEGIN {
            FS=","
            OFS=","
        }
        {
            # Capitalize the first letter of the name
            name = $1
            sub(/^./, toupper(substr(name, 1, 1)), name)

            # Do the unit conversions
            height_m = $2 / 10
            weight_kg = $3 / 10

            # Print the final formatted CSV line
            printf "%s,%s,%s\n", name, height_m, weight_kg
        }
    ' >> "$OUTPUT_FILE"
done

# --- Part 1.5: Display the CSV file content
echo "" # Add an empty line for spacing
cat "$OUTPUT_FILE"

# --- Part 2: Calculate and Print Averages with awk ---

# Use awk to read the generated CSV file
awk '
    BEGIN {
        FS="," # Set the field separator to a comma
        sum_height = 0
        sum_weight = 0
        count = 0
    }
    NR > 1 {
        sum_height += $2
        sum_weight += $3
        count++
    }
    END {
        if (count > 0) {
            avg_height = sum_height / count
            avg_weight = sum_weight / count
            printf "\nAverage Height: %.2f m\n", avg_height
            printf "Average Weight: %.2f kg\n", avg_weight
        }
    }
' "$OUTPUT_FILE"